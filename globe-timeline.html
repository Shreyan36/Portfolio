<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Shreyan • Globe Timeline</title>
<style>
  :root{--indigo:#4f46e5;--muted:#94a3b8}
  *{box-sizing:border-box}html,body{height:100%}
  body{margin:0;background:#0b0f17;color:#e5e7eb;font-family:system-ui,-apple-system,Inter,Segoe UI,Roboto,Arial;overflow:hidden}
  #scene{position:fixed;inset:0;z-index:0}
  .panel{position:fixed;left:24px;bottom:24px;z-index:2;width:min(620px,calc(100% - 48px));
    background:rgba(14,22,38,.86);border:1px solid rgba(79,70,229,.25);border-radius:16px;padding:18px 16px 14px;backdrop-filter:blur(14px)}
  .big{font-size:20px;color:#fff;margin:6px 0 2px;font-weight:700}
  .step{margin-top:4px;font-size:14px;color:var(--muted)}
  .controls{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-top:12px}
  .tags{display:flex;flex-wrap:wrap;gap:8px}.tag{font-size:12px;color:#e7e7ff;background:rgba(79,70,229,.20);border:1px solid rgba(126,34,206,.35);padding:6px 10px;border-radius:999px}
  .btns{display:flex;gap:10px}
  button{all:unset;cursor:pointer;border-radius:12px;font-weight:700;font-size:14px;padding:10px 14px;color:#fff;background:linear-gradient(135deg,#4f46e5,#7e22ce)}
  button.secondary{background:transparent;color:#e5e7eb;border:1px solid rgba(148,163,184,.28)}
  button:disabled{opacity:.5;cursor:not-allowed}
</style>
</head>
<body>
<div id="scene"></div>

<div class="panel">
  <div class="big" id="headline">Birth • Burdwan, India</div>
  <div class="step" id="copy">Starting point of the journey.</div>
  <div class="controls">
    <div class="tags" id="tags"></div>
    <div class="btns">
      <button class="secondary" id="prev">Prev</button>
      <button id="next">Next</button>
    </div>
  </div>
</div>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.159.0/build/three.module.js?v=2';
import { OrbitControls } from 'https://unpkg.com/three@0.159.0/examples/jsm/controls/OrbitControls.js?v=2';

const R = 1;
const scene = new THREE.Scene();
scene.fog = new THREE.FogExp2(0x06080d, 0.12);

const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
renderer.setSize(window.innerWidth, window.innerHeight);
renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
document.getElementById('scene').appendChild(renderer.domElement);

const camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 100);
camera.position.set(0, 1.2, 3.2);

const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true;
controls.enablePan = false;
controls.minDistance = 1.6;
controls.maxDistance = 6;
controls.autoRotate = true;
controls.autoRotateSpeed = 0.4;

// Lights
scene.add(new THREE.HemisphereLight(0xbfd4ff, 0x0b0f17, 1.0));
const dl = new THREE.DirectionalLight(0xffffff, 1.0);
dl.position.set(5,3,2);
scene.add(dl);

// Stars
const starsGeo = new THREE.BufferGeometry();
const starCount = 1400;
const positions = new Float32Array(starCount*3);
for (let i=0;i<starCount;i++){
  const r=40+Math.random()*40, th=Math.random()*Math.PI*2, ph=Math.acos(Math.random()*2-1);
  positions[i*3]=r*Math.sin(ph)*Math.cos(th);
  positions[i*3+1]=r*Math.cos(ph);
  positions[i*3+2]=r*Math.sin(ph)*Math.sin(th);
}
starsGeo.setAttribute('position', new THREE.BufferAttribute(positions,3));
scene.add(new THREE.Points(starsGeo, new THREE.PointsMaterial({color:0x98a2b3,size:0.1,opacity:0.7,transparent:true})));

// Earth (CORS-safe textures; falls back gracefully if blocked)
const loader = new THREE.TextureLoader();
loader.setCrossOrigin('anonymous');
const earthMat = new THREE.MeshPhongMaterial({ color:0x1b3a6b, specular:new THREE.Color("#222"), shininess:12 });

loader.load('https://planet-texture-maps.s3.us-east-2.amazonaws.com/earthmap4k.jpg',
  tex => { earthMat.map=tex; earthMat.needsUpdate=true; },
  undefined,
  () => console.warn('Diffuse texture failed; using solid color.')
);
loader.load('https://planet-texture-maps.s3.us-east-2.amazonaws.com/earthbump4k.jpg',
  tex => { earthMat.bumpMap=tex; earthMat.bumpScale=0.02; earthMat.needsUpdate=true; },
  undefined,
  () => {}
);

const earthGroup = new THREE.Group();
scene.add(earthGroup);

const earth = new THREE.Mesh(new THREE.SphereGeometry(R, 96, 96), earthMat);
earthGroup.add(earth);

const atmosphere = new THREE.Mesh(
  new THREE.SphereGeometry(R*1.02,64,64),
  new THREE.MeshBasicMaterial({color:0x7c3aed, transparent:true, opacity:.1, blending:THREE.AdditiveBlending})
);
earthGroup.add(atmosphere);

// Math helpers
const deg2rad = d => d * Math.PI / 180;
function latLngToVec3(lat, lng, radius=R){
  const phi=deg2rad(90-lat), theta=deg2rad(lng+180);
  return new THREE.Vector3(
    -(radius*Math.sin(phi)*Math.cos(theta)),
     radius*Math.cos(phi),
     radius*Math.sin(phi)*Math.sin(theta)
  );
}
function makePin(color){
  const g=new THREE.Group();
  const orb=new THREE.Mesh(new THREE.SphereGeometry(0.015,16,16), new THREE.MeshStandardMaterial({color, emissive:color, emissiveIntensity:.6}));
  const cone=new THREE.Mesh(new THREE.ConeGeometry(0.012,0.05,12), new THREE.MeshStandardMaterial({color, emissive:color, emissiveIntensity:.35}));
  cone.rotation.x=Math.PI; cone.position.y=0.04; g.add(orb,cone); return g;
}
function placePin(lat,lng,type="study"){
  const colors={home:0x10b981,study:0x22d3ee,work:0xf472b6,personal:0x22d3ee};
  const p=makePin(colors[type]||0x22d3ee);
  const pos=latLngToVec3(lat,lng,R+0.02); p.position.copy(pos); p.lookAt(pos.clone().multiplyScalar(2));
  earthGroup.add(p); return p;
}
function greatCircleCurve(a,b,c,d,alt=0.35,segs=140){
  const v1=latLngToVec3(a,b), v2=latLngToVec3(c,d);
  const vm=v1.clone().add(v2).multiplyScalar(.5).normalize().multiplyScalar(R+alt);
  return new THREE.CatmullRomCurve3([v1,vm,v2]).getPoints(segs);
}
function arcMesh(points,color=0xf59e0b){
  const geo=new THREE.BufferGeometry().setFromPoints(points);
  return new THREE.Line(geo, new THREE.LineBasicMaterial({color,transparent:true,opacity:.85}));
}
function makePlane(color=0xf59e0b){
  const g=new THREE.Group();
  const body=new THREE.Mesh(new THREE.ConeGeometry(0.015,0.08,8), new THREE.MeshStandardMaterial({color, metalness:.2, roughness:.3, emissive:color, emissiveIntensity:.2}));
  body.rotation.x=Math.PI/2; const wing=new THREE.Mesh(new THREE.BoxGeometry(0.04,0.003,0.01), new THREE.MeshStandardMaterial({color})); g.add(body,wing); return g;
}

// Steps (your journey)
const steps = [
  { key:"birth", headline:"Birth • Burdwan, India", copy:"Born in Burdwan, West Bengal, India.", tags:["Personal","Origin"],
    focus:{lat:23.2324,lng:87.8615,dist:2.3,tilt:.2},
    pins:[{lat:23.2324,lng:87.8615,type:"personal",label:"Burdwan"}]
  },
  { key:"school", headline:"Schooling • Burdwan, India", copy:"Completed primary and secondary schooling in Burdwan, excelling in science and mathematics.", tags:["School","Education"],
    focus:{lat:23.2324,lng:87.8615,dist:2.3,tilt:.2},
    pins:[{lat:23.2324,lng:87.8615,type:"study",label:"Burdwan"}]
  },
  { key:"undergrad", headline:"Undergraduate Studies • NIT Durgapur", copy:"Electronics and Communication Engineering at NIT Durgapur.", tags:["NIT","ECE","Undergraduate"],
    focus:{lat:23.5505,lng:87.2915,dist:2.3,tilt:.2},
    pins:[{lat:23.5505,lng:87.2915,type:"study",label:"NIT Durgapur"}],
    action:{type:"flight",from:{lat:23.2324,lng:87.8615,label:"Burdwan"},to:{lat:23.5505,lng:87.2915,label:"NIT Durgapur"}}
  },
  { key:"grad", headline:"Graduate Studies • University at Buffalo", copy:"Masters and PhD in Electrical Engineering at UB, specializing in nanophotonics and biosensing.", tags:["UB","Masters","PhD","USA"],
    focus:{lat:42.8864,lng:-78.8784,dist:2.3,tilt:.2},
    pins:[{lat:42.8864,lng:-78.8784,type:"study",label:"Buffalo"}],
    action:{type:"flight",from:{lat:22.5726,lng:88.3639,label:"Kolkata"},to:{lat:42.8864,lng:-78.8784,label:"Buffalo"}}
  },
  { key:"internship", headline:"Internship • Boston, USA", copy:"Summer internship in Boston focusing on SEM‑based process analysis for meta‑optic devices.", tags:["Internship","Boston"],
    focus:{lat:42.3601,lng:-71.0589,dist:2.3,tilt:.2},
    pins:[{lat:42.3601,lng:-71.0589,type:"work",label:"Boston"}],
    action:{type:"flight",from:{lat:42.8864,lng:-78.8784,label:"Buffalo"},to:{lat:42.3601,lng:-71.0589,label:"Boston"}}
  }
];

// UI refs
const headlineEl=document.getElementById('headline');
const copyEl=document.getElementById('copy');
const tagsEl=document.getElementById('tags');
const prevBtn=document.getElementById('prev');
const nextBtn=document.getElementById('next');

// State
let currentIndex = 0;
let pinObjects = [];
let activeArc = null;
let plane = null;
let planePath = null;
let planeProg = 0;

// Deep link helpers
function setURLStep(key){
  const u=new URL(location.href);
  u.searchParams.set('step',key);
  history.replaceState(null,'',u.toString());
}
function getURLStepIndex(){
  const k=new URL(location.href).searchParams.get('step');
  const i=steps.findIndex(s=>s.key===k);
  return i>=0?i:0;
}

// Camera ease
function easeCameraTo(lat,lng,dist=2.4,tilt=.2,ms=1200){
  const target=latLngToVec3(lat,lng);
  const qStart=earthGroup.quaternion.clone();
  const m=new THREE.Matrix4().lookAt(target,new THREE.Vector3(0,0,0),new THREE.Vector3(0,1,0));
  const qEnd=new THREE.Quaternion().setFromRotationMatrix(m).invert();
  const cStart=camera.position.clone();
  const cEnd=target.clone().normalize().multiplyScalar(dist);
  const t0=performance.now();
  (function anim(){
    const t=Math.min(1,(performance.now()-t0)/ms);
    const s=t*t*(3-2*t);
    THREE.Quaternion.slerp(qStart,qEnd,earthGroup.quaternion,s);
    camera.position.lerpVectors(cStart,cEnd,s);
    camera.lookAt(0,0,0);
    if(t<1) requestAnimationFrame(anim);
  })();
}

// Pins
function clearPins(){ pinObjects.forEach(p=>earthGroup.remove(p)); pinObjects=[]; }
function showPins(step){
  clearPins();
  (step.pins||[]).forEach(p=>{
    const obj=placePin(p.lat,p.lng,p.type);
    obj.userData={label:p.label};
    pinObjects.push(obj);
  });
}

// Flights
function clearFlight(){
  if(activeArc){earthGroup.remove(activeArc);activeArc=null;}
  if(plane){earthGroup.remove(plane);plane=null;planePath=null;planeProg=0;}
}
function launchFlight(from,to){
  clearFlight();
  const pts=greatCircleCurve(from.lat,from.lng,to.lat,to.lng,.35,160);
  activeArc=arcMesh(pts,0xf59e0b);
  earthGroup.add(activeArc);
  plane=makePlane();
  earthGroup.add(plane);
  planePath=pts; planeProg=0;
}

// UI render
function setUI(step){
  headlineEl.textContent=step.headline;
  copyEl.textContent=step.copy;
  tagsEl.innerHTML="";
  step.tags.forEach(t=>{
    const s=document.createElement('span');
    s.className='tag';
    s.textContent=t;
    tagsEl.appendChild(s);
  });
  prevBtn.disabled=(currentIndex===0);
  nextBtn.disabled=(currentIndex===steps.length-1);
}
function runStep(i,first=false){
  const step=steps[i];
  setUI(step);
  setURLStep(step.key);
  showPins(step);
  easeCameraTo(step.focus.lat,step.focus.lng,step.focus.dist,step.focus.tilt, first?800:1200);
  if(step.action?.type==="flight") launchFlight(step.action.from,step.action.to);
  else clearFlight();
}
prevBtn.onclick=()=>{ if(currentIndex>0){ currentIndex--; runStep(currentIndex); } };
nextBtn.onclick=()=>{ if(currentIndex<steps.length-1){ currentIndex++; runStep(currentIndex); } };

// Animate
function tick(){
  requestAnimationFrame(tick);
  controls.update();
  earth.rotation.y+=0.00015;
  if(plane && planePath){
    planeProg=Math.min(1,planeProg+0.003);
    const idx=Math.floor(planeProg*(planePath.length-1));
    const p=planePath[idx];
    const p2=planePath[Math.min(idx+1,planePath.length-1)];
    plane.position.set(p.x,p.y,p.z);
    const up=p.clone().normalize();
    const m=new THREE.Matrix4().lookAt(p,p2,up);
    plane.quaternion.setFromRotationMatrix(m);
    if(activeArc){ activeArc.material.opacity=0.6+0.25*Math.sin(performance.now()*0.004); }
  }
  renderer.render(scene,camera);
}
tick();

// Resize
addEventListener('resize',()=>{
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
});

// Boot
currentIndex = getURLStepIndex();
runStep(currentIndex,true);
</script>
</body>
</html>
